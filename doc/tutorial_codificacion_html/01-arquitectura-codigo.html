<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitectura del CÃ³digo - Tutorial CodificaciÃ³n Avanzada</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ—ï¸</text></svg>">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ Arquitectura del CÃ³digo</h1>
            <p>AnÃ¡lisis Profundo de la Estructura y Patrones de DiseÃ±o</p>
        </div>

        <div class="nav">
            <a href="index.html">ğŸ  Inicio</a>
            <a href="01-arquitectura-codigo.html" class="active">ğŸ—ï¸ Arquitectura</a>
            <a href="02-configuracion-sistema.html">âš™ï¸ ConfiguraciÃ³n</a>
            <a href="03-base-datos-avanzada.html">ğŸ—„ï¸ Base de Datos</a>
            <a href="04-customtkinter-avanzado.html">ğŸ¨ CustomTkinter</a>
            <a href="05-sistema-ventanas.html">ğŸªŸ Sistema Ventanas</a>
            <a href="06-logging-debugging.html">ğŸ› Logging & Debug</a>
            <a href="07-testing-avanzado.html">ğŸ§ª Testing</a>
            <a href="08-patrones-diseno.html">ğŸ”§ Patrones</a>
            <a href="09-optimizacion-performance.html">âš¡ Performance</a>
        </div>

        <div class="alert alert-info">
            <h4>ğŸ¯ FilosofÃ­a ArquitectÃ³nica</h4>
            <p>FacturaciÃ³n FÃ¡cil implementa una <strong>arquitectura por capas pragmÃ¡tica</strong> que prioriza la simplicidad, mantenibilidad y escalabilidad. No utiliza frameworks complejos, sino patrones de diseÃ±o bien establecidos aplicados de manera inteligente.</p>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸ—ï¸ Estructura ArquitectÃ³nica Real
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h3>ğŸ“ OrganizaciÃ³n de Directorios</h3>
                        <pre><code>facturacion_facil/
â”œâ”€â”€ main.py                     # ğŸš€ Punto de entrada
â”œâ”€â”€ requirements.txt            # ğŸ“¦ Dependencias
â”œâ”€â”€ config.json                # âš™ï¸ ConfiguraciÃ³n externa
â”œâ”€â”€ facturacion.db             # ğŸ—„ï¸ Base de datos SQLite
â”‚
â”œâ”€â”€ database/                   # ğŸ—„ï¸ CAPA DE DATOS
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ database.py            # Gestor de conexiones
â”‚   â”œâ”€â”€ models.py              # Modelos de dominio
â”‚   â””â”€â”€ optimized_models.py    # Modelos optimizados
â”‚
â”œâ”€â”€ ui/                        # ğŸ¨ CAPA DE PRESENTACIÃ“N
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main_window.py         # Ventana principal
â”‚   â”œâ”€â”€ productos.py           # GestiÃ³n productos
â”‚   â”œâ”€â”€ facturas.py            # GestiÃ³n facturas
â”‚   â”œâ”€â”€ organizacion.py        # ConfiguraciÃ³n empresa
â”‚   â”œâ”€â”€ stock.py               # GestiÃ³n inventario
â”‚   â””â”€â”€ search_window.py       # BÃºsqueda avanzada
â”‚
â”œâ”€â”€ utils/                     # ğŸ”§ CAPA DE SERVICIOS
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py              # GestiÃ³n configuraciÃ³n
â”‚   â”œâ”€â”€ logger.py              # Sistema logging
â”‚   â”œâ”€â”€ translations.py        # InternacionalizaciÃ³n
â”‚   â””â”€â”€ pdf_generator.py       # GeneraciÃ³n PDFs
â”‚
â”œâ”€â”€ common/                    # ğŸ”„ COMPONENTES COMUNES
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ui_components.py       # Componentes UI base
â”‚   â”œâ”€â”€ validators.py          # Validadores de datos
â”‚   â””â”€â”€ custom_dialogs.py      # DiÃ¡logos personalizados
â”‚
â”œâ”€â”€ tests/                     # ğŸ§ª TESTING
â”‚   â”œâ”€â”€ unit/                  # Tests unitarios
â”‚   â”œâ”€â”€ integration/           # Tests integraciÃ³n
â”‚   â””â”€â”€ ui/                    # Tests interfaz
â”‚
â””â”€â”€ assets/                    # ğŸ“ RECURSOS
    â”œâ”€â”€ images/                # ImÃ¡genes productos
    â””â”€â”€ logos/                 # Logos empresa</code></pre>
                    </div>
                    <div class="col">
                        <h3>ğŸ¯ Principios ArquitectÃ³nicos</h3>
                        <ul>
                            <li><span class="status-ok">âœ…</span> <strong>SeparaciÃ³n de Responsabilidades</strong><br>
                                <small>Cada capa tiene una responsabilidad especÃ­fica y bien definida</small></li>
                            <li><span class="status-ok">âœ…</span> <strong>Bajo Acoplamiento</strong><br>
                                <small>Las capas se comunican a travÃ©s de interfaces claras</small></li>
                            <li><span class="status-ok">âœ…</span> <strong>Alta CohesiÃ³n</strong><br>
                                <small>Elementos relacionados estÃ¡n agrupados lÃ³gicamente</small></li>
                            <li><span class="status-ok">âœ…</span> <strong>InversiÃ³n de Dependencias</strong><br>
                                <small>Las capas superiores no dependen de implementaciones concretas</small></li>
                            <li><span class="status-ok">âœ…</span> <strong>Principio DRY</strong><br>
                                <small>CÃ³digo comÃºn centralizado en mÃ³dulos reutilizables</small></li>
                            <li><span class="status-ok">âœ…</span> <strong>ConfiguraciÃ³n Externa</strong><br>
                                <small>Comportamiento configurable sin recompilaciÃ³n</small></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸš€ Punto de Entrada: main.py
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <h4>ğŸ“‹ AnÃ¡lisis del CÃ³digo de Entrada</h4>
                    <p>El archivo <code>main.py</code> implementa un patrÃ³n de inicializaciÃ³n robusto con manejo de errores completo:</p>
                </div>
                
                <pre><code>#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
FacturaciÃ³n FÃ¡cil
AplicaciÃ³n de facturaciÃ³n simple con gestiÃ³n de productos, stock y clientes.
"""

import sys
import os

# Agregar el directorio actual al path para importar mÃ³dulos
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from ui.main_window import MainWindow
from database.database import db
from utils.logger import app_logger, log_info, log_error, log_exception

def main():
    """FunciÃ³n principal de la aplicaciÃ³n"""
    try:
        # Inicializar logging
        app_logger.log_startup_info()
        log_info("=== Iniciando aplicaciÃ³n FacturaciÃ³n FÃ¡cil ===")

        # Inicializar la base de datos
        log_info("Inicializando base de datos...")
        db.init_database()
        log_info("Base de datos inicializada correctamente")

        # Crear y ejecutar la aplicaciÃ³n
        log_info("Creando ventana principal")
        app = MainWindow()

        log_info("Iniciando bucle principal de la aplicaciÃ³n")
        app.run()

        log_info("AplicaciÃ³n cerrada normalmente")

    except Exception as e:
        log_exception(e, "main")
        log_error(f"Error crÃ­tico al iniciar la aplicaciÃ³n: {str(e)}")

        # Mostrar error al usuario si es posible
        try:
            import tkinter.messagebox as messagebox
            messagebox.showerror(
                "Error CrÃ­tico",
                f"Error inesperado en la aplicaciÃ³n:\n{str(e)}\n\n"
                f"Revisa los logs en el directorio 'logs' para mÃ¡s detalles."
            )
        except:
            print(f"Error crÃ­tico: {str(e)}")

        sys.exit(1)

if __name__ == "__main__":
    main()</code></pre>

                <div class="row">
                    <div class="col">
                        <h3>ğŸ” CaracterÃ­sticas TÃ©cnicas</h3>
                        <ul>
                            <li><strong>GestiÃ³n de Path:</strong> ConfiguraciÃ³n automÃ¡tica del PYTHONPATH</li>
                            <li><strong>Logging Temprano:</strong> InicializaciÃ³n del sistema de logs antes que nada</li>
                            <li><strong>InicializaciÃ³n Secuencial:</strong> Base de datos â†’ UI â†’ Bucle principal</li>
                            <li><strong>Manejo de Errores:</strong> Captura y logging de excepciones crÃ­ticas</li>
                            <li><strong>Graceful Shutdown:</strong> Cierre controlado de la aplicaciÃ³n</li>
                        </ul>
                    </div>
                    <div class="col">
                        <h3>ğŸ›¡ï¸ Robustez y Seguridad</h3>
                        <ul>
                            <li><strong>Try-Catch Global:</strong> Captura de errores no manejados</li>
                            <li><strong>Logging Detallado:</strong> Trazabilidad completa de la ejecuciÃ³n</li>
                            <li><strong>Fallback UI:</strong> Mensaje de error incluso si la UI falla</li>
                            <li><strong>Exit Codes:</strong> CÃ³digos de salida apropiados para scripts</li>
                            <li><strong>Encoding UTF-8:</strong> Soporte completo para caracteres especiales</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸ—„ï¸ Capa de Datos: Arquitectura de Persistencia
            </div>
            <div class="card-body">
                <h3>ğŸ“Š PatrÃ³n Repository Implementado</h3>
                <p>La capa de datos implementa un patrÃ³n Repository simplificado que abstrae el acceso a SQLite:</p>
                
                <pre><code># database/database.py - Gestor de Base de Datos
class DatabaseManager:
    """Gestor singleton de la base de datos SQLite"""
    
    _instance = None
    _connection = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(DatabaseManager, cls).__new__(cls)
        return cls._instance
    
    def __init__(self):
        if not hasattr(self, 'initialized'):
            self.db_path = "facturacion.db"
            self.logger = get_logger("database")
            self.initialized = True
    
    def get_connection(self):
        """Obtiene una conexiÃ³n a la base de datos"""
        if self._connection is None:
            self._connection = sqlite3.connect(
                self.db_path, 
                check_same_thread=False,
                timeout=30.0
            )
            self._connection.row_factory = sqlite3.Row
        return self._connection
    
    def execute_query(self, query, params=None):
        """Ejecuta una query con manejo de errores y logging"""
        try:
            conn = self.get_connection()
            cursor = conn.cursor()
            
            if params:
                cursor.execute(query, params)
            else:
                cursor.execute(query)
            
            if query.strip().upper().startswith(('INSERT', 'UPDATE', 'DELETE')):
                conn.commit()
                return cursor.lastrowid
            else:
                return cursor.fetchall()
                
        except sqlite3.Error as e:
            self.logger.error(f"Error en query: {query[:100]}... - {str(e)}")
            raise
        except Exception as e:
            self.logger.error(f"Error inesperado en query: {str(e)}")
            raise

# Instancia singleton global
db = DatabaseManager()</code></pre>

                <div class="row">
                    <div class="col">
                        <h3>ğŸ¯ CaracterÃ­sticas del PatrÃ³n</h3>
                        <ul>
                            <li><strong>Singleton:</strong> Una sola instancia de conexiÃ³n</li>
                            <li><strong>Connection Pooling:</strong> ReutilizaciÃ³n de conexiones</li>
                            <li><strong>Row Factory:</strong> Acceso por nombre de columna</li>
                            <li><strong>Timeout:</strong> PrevenciÃ³n de bloqueos</li>
                            <li><strong>Thread Safety:</strong> ConfiguraciÃ³n para mÃºltiples hilos</li>
                            <li><strong>Logging:</strong> Trazabilidad de todas las operaciones</li>
                        </ul>
                    </div>
                    <div class="col">
                        <h3>ğŸ”§ Ventajas de la ImplementaciÃ³n</h3>
                        <ul>
                            <li><strong>Simplicidad:</strong> No requiere ORM complejo</li>
                            <li><strong>Performance:</strong> Acceso directo a SQLite</li>
                            <li><strong>Control:</strong> Queries optimizadas manualmente</li>
                            <li><strong>Debugging:</strong> FÃ¡cil de debuggear y optimizar</li>
                            <li><strong>Portabilidad:</strong> Sin dependencias externas</li>
                            <li><strong>Escalabilidad:</strong> FÃ¡cil migraciÃ³n a otros SGBD</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸ“‹ Modelos de Dominio: Active Record Pattern
            </div>
            <div class="card-body">
                <h3>ğŸ—ï¸ ImplementaciÃ³n del PatrÃ³n Active Record</h3>
                <p>Los modelos implementan una versiÃ³n simplificada del patrÃ³n Active Record, donde cada objeto conoce cÃ³mo persistirse:</p>
                
                <pre><code># database/models.py - Modelo Producto
class Producto:
    """Modelo de producto con patrÃ³n Active Record"""
    
    def __init__(self, id=None, nombre="", referencia="", precio=0.0, 
                 categoria="", descripcion="", imagen_path="", iva_recomendado=21.0):
        self.id = id
        self.nombre = nombre
        self.referencia = referencia
        self.precio = precio
        self.categoria = categoria
        self.descripcion = descripcion
        self.imagen_path = imagen_path
        self.iva_recomendado = iva_recomendado
    
    def save(self):
        """Guarda el producto en la base de datos"""
        if self.id:
            # UPDATE - Producto existente
            query = '''UPDATE productos SET nombre=?, referencia=?, precio=?, 
                      categoria=?, descripcion=?, imagen_path=?, iva_recomendado=?
                      WHERE id=?'''
            params = (self.nombre, self.referencia, self.precio, 
                     self.categoria, self.descripcion, self.imagen_path, 
                     self.iva_recomendado, self.id)
            db.execute_query(query, params)
        else:
            # INSERT - Nuevo producto
            query = '''INSERT INTO productos (nombre, referencia, precio, 
                      categoria, descripcion, imagen_path, iva_recomendado) 
                      VALUES (?, ?, ?, ?, ?, ?, ?)'''
            params = (self.nombre, self.referencia, self.precio, 
                     self.categoria, self.descripcion, self.imagen_path, 
                     self.iva_recomendado)
            self.id = db.execute_query(query, params)
        return self.id
    
    def delete(self):
        """Elimina el producto de la base de datos"""
        if self.id:
            query = "DELETE FROM productos WHERE id=?"
            db.execute_query(query, (self.id,))
            self.id = None
    
    @staticmethod
    def get_all():
        """Obtiene todos los productos"""
        query = "SELECT * FROM productos ORDER BY nombre"
        results = db.execute_query(query)
        productos = []
        for row in results:
            producto = Producto(
                id=row['id'], nombre=row['nombre'], 
                referencia=row['referencia'], precio=row['precio'],
                categoria=row['categoria'], descripcion=row['descripcion'],
                imagen_path=row['imagen_path'], iva_recomendado=row['iva_recomendado']
            )
            productos.append(producto)
        return productos
    
    @staticmethod
    def get_by_id(producto_id):
        """Obtiene un producto por su ID"""
        query = "SELECT * FROM productos WHERE id=?"
        results = db.execute_query(query, (producto_id,))
        if results:
            row = results[0]
            return Producto(
                id=row['id'], nombre=row['nombre'], 
                referencia=row['referencia'], precio=row['precio'],
                categoria=row['categoria'], descripcion=row['descripcion'],
                imagen_path=row['imagen_path'], iva_recomendado=row['iva_recomendado']
            )
        return None</code></pre>

                <div class="alert alert-warning">
                    <h4>ğŸ¯ Ventajas del Active Record en este Contexto</h4>
                    <ul>
                        <li><strong>Simplicidad:</strong> Cada objeto sabe cÃ³mo persistirse</li>
                        <li><strong>Intuitividad:</strong> API natural para desarrolladores</li>
                        <li><strong>Menos CÃ³digo:</strong> No requiere mappers separados</li>
                        <li><strong>Debugging FÃ¡cil:</strong> LÃ³gica de persistencia visible</li>
                        <li><strong>Prototipado RÃ¡pido:</strong> Desarrollo Ã¡gil de funcionalidades</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="navigation-buttons">
            <a href="index.html" class="btn btn-secondary">â¬…ï¸ Volver al Inicio</a>
            <a href="02-configuracion-sistema.html" class="btn btn-primary">Siguiente: Sistema de ConfiguraciÃ³n â¡ï¸</a>
        </div>

        <div class="footer">
            <p>&copy; 2024 FacturaciÃ³n FÃ¡cil - Tutorial de CodificaciÃ³n Avanzada</p>
        </div>
    </div>

    <script src="enhance_code_blocks.js"></script>
</body>
</html>
