<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logging & Debugging - Tutorial Codificación Avanzada</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🐛</text></svg>">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🐛 Logging & Debugging</h1>
            <p>Sistema Avanzado de Logs Rotativos y Debugging Profesional</p>
        </div>

        <div class="nav">
            <a href="index.html">🏠 Inicio</a>
            <a href="01-arquitectura-codigo.html">🏗️ Arquitectura</a>
            <a href="02-configuracion-sistema.html">⚙️ Configuración</a>
            <a href="03-base-datos-avanzada.html">🗄️ Base de Datos</a>
            <a href="04-customtkinter-avanzado.html">🎨 CustomTkinter</a>
            <a href="05-sistema-ventanas.html">🪟 Sistema Ventanas</a>
            <a href="06-logging-debugging.html" class="active">🐛 Logging & Debug</a>
            <a href="07-testing-avanzado.html">🧪 Testing</a>
            <a href="08-patrones-diseno.html">🔧 Patrones</a>
            <a href="09-optimizacion-performance.html">⚡ Performance</a>
        </div>

        <div class="alert alert-info">
            <h4>🎯 Filosofía de Logging Profesional</h4>
            <p>Facturación Fácil implementa un <strong>sistema de logging de nivel empresarial</strong> con rotación automática, separación por niveles, logging específico por módulos y herramientas avanzadas de debugging. El sistema está diseñado para facilitar el mantenimiento y la resolución de problemas en producción.</p>
        </div>

        <div class="card">
            <div class="card-header">
                🏗️ Arquitectura del Sistema de Logging
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h3>📊 Estructura de Logs</h3>
                        <pre><code>logs/
├── facturacion_facil.log          # Log principal
├── facturacion_facil.log.1        # Backup 1 (5MB)
├── facturacion_facil.log.2        # Backup 2
├── facturacion_facil.log.3        # Backup 3
├── facturacion_facil.log.4        # Backup 4
├── facturacion_facil.log.5        # Backup 5
├── facturacion_facil_errors.log   # Solo errores
├── facturacion_facil_errors.log.1 # Error backup 1
├── facturacion_facil_errors.log.2 # Error backup 2
├── facturacion_facil_errors.log.3 # Error backup 3
└── session_20241201_143022.log    # Log de sesión</code></pre>
                    </div>
                    <div class="col">
                        <h3>📋 Niveles de Logging</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nivel</th>
                                    <th>Uso</th>
                                    <th>Destino</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>DEBUG</strong></td>
                                    <td>Información detallada</td>
                                    <td>Solo archivo</td>
                                </tr>
                                <tr>
                                    <td><strong>INFO</strong></td>
                                    <td>Información general</td>
                                    <td>Archivo + Consola</td>
                                </tr>
                                <tr>
                                    <td><strong>WARNING</strong></td>
                                    <td>Advertencias</td>
                                    <td>Archivo + Consola</td>
                                </tr>
                                <tr>
                                    <td><strong>ERROR</strong></td>
                                    <td>Errores</td>
                                    <td>Archivo + Errors + Consola</td>
                                </tr>
                                <tr>
                                    <td><strong>CRITICAL</strong></td>
                                    <td>Errores críticos</td>
                                    <td>Todos los destinos</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                🔧 AppLogger: Clase Principal de Logging
            </div>
            <div class="card-body">
                <h3>🏗️ Implementación del Sistema de Logging</h3>
                <p>La clase <code>AppLogger</code> implementa un sistema completo con rotación automática y múltiples handlers:</p>
                
                <pre><code># utils/logger.py - Sistema de Logging Profesional
class AppLogger:
    """Clase para manejar el logging de la aplicación con características empresariales"""
    
    def __init__(self, app_name="facturacion_facil"):
        self.app_name = app_name
        self.log_dir = "logs"
        self.setup_logging()
    
    def setup_logging(self):
        """Configura el sistema de logging con múltiples handlers"""
        # Crear directorio de logs si no existe
        os.makedirs(self.log_dir, exist_ok=True)
        
        # Configurar el logger principal
        self.logger = logging.getLogger(self.app_name)
        self.logger.setLevel(logging.DEBUG)
        
        # Evitar duplicar handlers si ya existen
        if self.logger.handlers:
            return
        
        # Formato detallado para archivos
        file_formatter = logging.Formatter(
            '%(asctime)s - %(name)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        
        # Formato simplificado para consola
        console_formatter = logging.Formatter(
            '%(asctime)s - %(levelname)s - %(message)s',
            datefmt='%H:%M:%S'
        )
        
        # 1. Handler para archivo principal (rotativo)
        main_log_file = os.path.join(self.log_dir, f"{self.app_name}.log")
        file_handler = RotatingFileHandler(
            main_log_file,
            maxBytes=5*1024*1024,  # 5MB por archivo
            backupCount=5,         # Mantener 5 backups
            encoding='utf-8'
        )
        file_handler.setLevel(logging.DEBUG)
        file_handler.setFormatter(file_formatter)
        
        # 2. Handler para errores (archivo separado)
        error_log_file = os.path.join(self.log_dir, f"{self.app_name}_errors.log")
        error_handler = RotatingFileHandler(
            error_log_file,
            maxBytes=2*1024*1024,  # 2MB para errores
            backupCount=3,         # 3 backups para errores
            encoding='utf-8'
        )
        error_handler.setLevel(logging.ERROR)
        error_handler.setFormatter(file_formatter)
        
        # 3. Handler para consola (solo INFO y superior)
        console_handler = logging.StreamHandler(sys.stdout)
        console_handler.setLevel(logging.INFO)
        console_handler.setFormatter(console_formatter)
        
        # Añadir todos los handlers
        self.logger.addHandler(file_handler)
        self.logger.addHandler(error_handler)
        self.logger.addHandler(console_handler)
        
        # Log de inicio del sistema
        self.logger.info(f"=== Iniciando {self.app_name} ===")
        self.logger.info(f"Directorio de logs: {os.path.abspath(self.log_dir)}")
    
    def get_logger(self, module_name=None):
        """Obtiene un logger específico para un módulo"""
        if module_name:
            # Logger jerárquico: facturacion_facil.module_name
            return logging.getLogger(f"{self.app_name}.{module_name}")
        return self.logger</code></pre>

                <div class="row">
                    <div class="col">
                        <h3>🎯 Características Avanzadas</h3>
                        <ul>
                            <li><strong>Rotación Automática:</strong> Archivos de 5MB con 5 backups</li>
                            <li><strong>Separación de Errores:</strong> Archivo dedicado para errores</li>
                            <li><strong>Encoding UTF-8:</strong> Soporte completo para caracteres especiales</li>
                            <li><strong>Múltiples Destinos:</strong> Archivo, errores y consola</li>
                            <li><strong>Formato Detallado:</strong> Timestamp, módulo, línea de código</li>
                        </ul>
                    </div>
                    <div class="col">
                        <h3>📊 Configuración de Handlers</h3>
                        <ul>
                            <li><strong>File Handler:</strong> DEBUG+ → archivo principal</li>
                            <li><strong>Error Handler:</strong> ERROR+ → archivo de errores</li>
                            <li><strong>Console Handler:</strong> INFO+ → salida estándar</li>
                            <li><strong>Session Handler:</strong> DEBUG+ → archivo de sesión</li>
                            <li><strong>Module Loggers:</strong> Loggers específicos por módulo</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                🎯 Logging Especializado por Dominio
            </div>
            <div class="card-body">
                <h3>📋 Funciones de Logging Específicas</h3>
                <p>El sistema incluye funciones especializadas para diferentes tipos de operaciones:</p>
                
                <pre><code># utils/logger.py - Funciones Especializadas
class AppLogger:
    
    def log_user_action(self, action, details=""):
        """Log una acción del usuario con contexto"""
        self.logger.info(f"👤 Acción usuario: {action} - {details}")
    
    def log_database_operation(self, operation, table="", details=""):
        """Log una operación de base de datos"""
        self.logger.debug(f"🗄️ DB {operation} en {table}: {details}")
    
    def log_file_operation(self, operation, file_path="", details=""):
        """Log una operación de archivo"""
        self.logger.debug(f"📁 Archivo {operation}: {file_path} - {details}")
    
    def log_exception(self, exception, context=""):
        """Log una excepción con stack trace completo"""
        self.logger.error(f"💥 Excepción en {context}: {str(exception)}", exc_info=True)
    
    def log_startup_info(self):
        """Log información del sistema al inicio"""
        self.logger.info(f"🐍 Python version: {sys.version}")
        self.logger.info(f"📂 Directorio de trabajo: {os.getcwd()}")
        self.logger.info(f"⚙️ Argumentos: {sys.argv}")
    
    def create_session_log(self):
        """Crea un log específico para la sesión actual"""
        session_time = datetime.now().strftime("%Y%m%d_%H%M%S")
        session_log_file = os.path.join(self.log_dir, f"session_{session_time}.log")
        
        # Handler específico para la sesión
        session_handler = logging.FileHandler(session_log_file, encoding='utf-8')
        session_handler.setLevel(logging.DEBUG)
        
        formatter = logging.Formatter(
            '%(asctime)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        session_handler.setFormatter(formatter)
        
        # Logger específico para la sesión
        session_logger = logging.getLogger(f"{self.app_name}.session")
        session_logger.addHandler(session_handler)
        session_logger.setLevel(logging.DEBUG)
        
        session_logger.info(f"🚀 Nueva sesión iniciada: {session_time}")
        return session_logger

# Funciones de conveniencia globales
def log_user_action(action, details=""):
    """Log una acción del usuario"""
    app_logger.log_user_action(action, details)

def log_database_operation(operation, table="", details=""):
    """Log una operación de base de datos"""
    app_logger.log_database_operation(operation, table, details)

def log_file_operation(operation, file_path="", details=""):
    """Log una operación de archivo"""
    app_logger.log_file_operation(operation, file_path, details)

def log_exception(exception, context=""):
    """Log una excepción con contexto"""
    app_logger.log_exception(exception, context)</code></pre>

                <div class="row">
                    <div class="col">
                        <h3>🎯 Ejemplos de Uso</h3>
                        <pre><code># En ui/productos.py
from utils.logger import log_user_action, log_file_operation

def guardar_producto(self):
    log_user_action("Guardar producto", f"Ref: {self.referencia}")
    
    if self.imagen_path:
        log_file_operation("COPY", self.imagen_path, "assets/images/")
    
    # ... lógica de guardado ...

# En database/database.py
from utils.logger import log_database_operation

def execute_query(self, query, params=None):
    log_database_operation("EXECUTE", "", query[:50] + "...")
    # ... ejecución de query ...</code></pre>
                    </div>
                    <div class="col">
                        <h3>📊 Tipos de Logging</h3>
                        <ul>
                            <li><strong>👤 User Actions:</strong> Clicks, formularios, navegación</li>
                            <li><strong>🗄️ Database Ops:</strong> Queries, transacciones, errores DB</li>
                            <li><strong>📁 File Ops:</strong> Lectura, escritura, copia de archivos</li>
                            <li><strong>💥 Exceptions:</strong> Errores con stack trace completo</li>
                            <li><strong>🚀 System Info:</strong> Información de inicio y configuración</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                🔍 Herramientas de Debugging Avanzado
            </div>
            <div class="card-body">
                <h3>🛠️ Técnicas de Debugging Implementadas</h3>
                <p>El sistema incluye herramientas avanzadas para debugging y análisis de problemas:</p>
                
                <pre><code># test/debug/debug_stock_search.py - Debugging Específico
def debug_stock_search():
    """Función de debugging para problemas específicos"""
    print("🔧 Debug - Búsqueda Stock")
    print("=" * 40)
    
    # 1. Test de simulación de datos
    def test_stock_search_simulation():
        """Simula el comportamiento de búsqueda sin UI"""
        try:
            # Datos de prueba
            stock_data = [
                {'producto_nombre': 'Laptop Dell', 'referencia': 'DELL001'},
                {'producto_nombre': 'Mouse Logitech', 'referencia': 'LOG001'},
                {'producto_nombre': 'Teclado Mecánico', 'referencia': 'TEC001'}
            ]
            
            # Simular búsqueda
            search_term = "dell"
            filtered_data = [
                item for item in stock_data 
                if search_term.lower() in item['producto_nombre'].lower() or
                   search_term.lower() in item['referencia'].lower()
            ]
            
            assert len(filtered_data) == 1, f"Esperado 1, obtenido {len(filtered_data)}"
            assert filtered_data[0]['referencia'] == 'DELL001'
            
            print("✅ Simulación de búsqueda funciona correctamente")
            return True
            
        except Exception as e:
            print(f"❌ Error en simulación: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    # 2. Test de eventos tkinter
    def test_real_tkinter_behavior():
        """Test con tkinter real para verificar eventos"""
        try:
            import tkinter as tk
            
            root = tk.Tk()
            root.withdraw()  # Ocultar ventana
            
            # Variables de test
            search_var = tk.StringVar()
            filter_called = []
            
            def mock_filter(*args):
                search_text = search_var.get()
                filter_called.append(search_text)
                print(f"🔍 Filtro llamado con: '{search_text}'")
            
            # Bind del evento
            search_var.trace('w', mock_filter)
            
            # Tests
            search_var.set("test")
            root.update()
            
            search_var.set("dell")
            root.update()
            
            search_var.set("")
            root.update()
            
            root.destroy()
            
            print(f"✅ Eventos tkinter: {len(filter_called)} llamadas")
            return True
            
        except Exception as e:
            print(f"❌ Error en test tkinter: {e}")
            return False
    
    # Ejecutar tests
    success1 = test_stock_search_simulation()
    success2 = test_real_tkinter_behavior()
    
    if success1 and success2:
        print("\n🎉 DEBUGGING COMPLETO")
        print("✅ Lógica de filtrado: Funciona")
        print("✅ Eventos tkinter: Funcionan")
    
    return success1 and success2</code></pre>

                <div class="row">
                    <div class="col">
                        <h3>🔧 Técnicas de Debugging</h3>
                        <ul>
                            <li><strong>Simulación de Datos:</strong> Test sin dependencias UI</li>
                            <li><strong>Mock Objects:</strong> Simulación de componentes complejos</li>
                            <li><strong>Event Testing:</strong> Verificación de eventos tkinter</li>
                            <li><strong>Isolation Testing:</strong> Test de componentes aislados</li>
                            <li><strong>Stack Trace Analysis:</strong> Análisis detallado de errores</li>
                        </ul>
                    </div>
                    <div class="col">
                        <h3>📊 Comandos de Debugging</h3>
                        <pre><code># Ver logs en tiempo real
tail -f logs/facturacion_facil.log

# Ver últimas 50 líneas
tail -50 logs/facturacion_facil.log

# Ver solo errores
cat logs/facturacion_facil_errors.log

# Buscar en logs
grep "ERROR" logs/facturacion_facil.log

# Ver logs de sesión específica
ls logs/session_*.log | tail -1 | xargs cat</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                📊 Análisis de Logs y Monitoreo
            </div>
            <div class="card-body">
                <h3>📈 Ejemplo de Logs en Producción</h3>
                <p>Ejemplo real de logs generados por el sistema:</p>
                
                <pre><code># logs/facturacion_facil.log - Ejemplo Real
2024-12-01 14:30:22 - facturacion_facil - INFO - main.py:15 - === Iniciando facturacion_facil ===
2024-12-01 14:30:22 - facturacion_facil - INFO - logger.py:76 - Directorio de logs: /home/pascal/for_django/facturacion_facil/logs
2024-12-01 14:30:22 - facturacion_facil - INFO - logger.py:86 - 🐍 Python version: 3.8.10 (default, Nov 14 2022, 12:59:47)
2024-12-01 14:30:22 - facturacion_facil - INFO - logger.py:87 - 📂 Directorio de trabajo: /home/pascal/for_django/facturacion_facil
2024-12-01 14:30:22 - facturacion_facil - INFO - main.py:20 - Inicializando base de datos...
2024-12-01 14:30:22 - facturacion_facil.database - DEBUG - database.py:45 - 🗄️ DB EXECUTE en : PRAGMA foreign_keys = ON...
2024-12-01 14:30:22 - facturacion_facil - INFO - main.py:22 - Base de datos inicializada correctamente
2024-12-01 14:30:22 - facturacion_facil - INFO - main.py:25 - Creando ventana principal
2024-12-01 14:30:23 - facturacion_facil - INFO - main.py:28 - Iniciando bucle principal de la aplicación
2024-12-01 14:30:45 - facturacion_facil.productos - INFO - productos.py:156 - 👤 Acción usuario: Abrir gestión productos - 
2024-12-01 14:30:52 - facturacion_facil.productos - INFO - productos.py:234 - 👤 Acción usuario: Seleccionar imagen - 
2024-12-01 14:30:52 - facturacion_facil.productos - DEBUG - productos.py:245 - 📁 Archivo COPY: /home/pascal/Pictures/producto.jpg - Copiado a assets/images/
2024-12-01 14:31:05 - facturacion_facil.productos - INFO - productos.py:189 - 👤 Acción usuario: Guardar producto - Ref: PROD001
2024-12-01 14:31:05 - facturacion_facil.database - DEBUG - database.py:67 - 🗄️ DB INSERT en productos: Producto PROD001 guardado</code></pre>

                <div class="alert alert-success">
                    <h4>🎯 Información Capturada en Logs</h4>
                    <ul>
                        <li><strong>Timestamp Preciso:</strong> Fecha y hora exacta de cada evento</li>
                        <li><strong>Módulo y Línea:</strong> Ubicación exacta en el código</li>
                        <li><strong>Nivel de Severidad:</strong> DEBUG, INFO, WARNING, ERROR, CRITICAL</li>
                        <li><strong>Contexto de Acción:</strong> Qué estaba haciendo el usuario</li>
                        <li><strong>Detalles Técnicos:</strong> Parámetros, archivos, queries SQL</li>
                        <li><strong>Stack Traces:</strong> Información completa de errores</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="navigation-buttons">
            <a href="05-sistema-ventanas.html" class="btn btn-secondary">⬅️ Sistema de Ventanas</a>
            <a href="07-testing-avanzado.html" class="btn btn-primary">Siguiente: Testing Avanzado ➡️</a>
        </div>

        <div class="footer">
            <p>&copy; 2024 Facturación Fácil - Tutorial de Codificación Avanzada</p>
        </div>
    </div>

    <script src="enhance_code_blocks.js"></script>
</body>
</html>
