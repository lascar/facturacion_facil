<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de ConfiguraciÃ³n - Tutorial CodificaciÃ³n Avanzada</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš™ï¸</text></svg>">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš™ï¸ Sistema de ConfiguraciÃ³n</h1>
            <p>GestiÃ³n Avanzada de Settings y ConfiguraciÃ³n DinÃ¡mica</p>
        </div>

        <div class="nav">
            <a href="index.html">ğŸ  Inicio</a>
            <a href="01-arquitectura-codigo.html">ğŸ—ï¸ Arquitectura</a>
            <a href="02-configuracion-sistema.html" class="active">âš™ï¸ ConfiguraciÃ³n</a>
            <a href="03-base-datos-avanzada.html">ğŸ—„ï¸ Base de Datos</a>
            <a href="04-customtkinter-avanzado.html">ğŸ¨ CustomTkinter</a>
            <a href="05-sistema-ventanas.html">ğŸªŸ Sistema Ventanas</a>
            <a href="06-logging-debugging.html">ğŸ› Logging & Debug</a>
            <a href="07-testing-avanzado.html">ğŸ§ª Testing</a>
            <a href="08-patrones-diseno.html">ğŸ”§ Patrones</a>
            <a href="09-optimizacion-performance.html">âš¡ Performance</a>
        </div>

        <div class="alert alert-info">
            <h4>ğŸ¯ FilosofÃ­a de ConfiguraciÃ³n</h4>
            <p>El sistema de configuraciÃ³n implementa un <strong>patrÃ³n hÃ­brido</strong> que combina configuraciÃ³n externa (JSON), configuraciÃ³n en base de datos y configuraciÃ³n en tiempo de ejecuciÃ³n. Prioriza la flexibilidad sin sacrificar la simplicidad.</p>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸ—ï¸ Arquitectura del Sistema de ConfiguraciÃ³n
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h3>ğŸ“Š Capas de ConfiguraciÃ³n</h3>
                        <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ğŸ›ï¸ RUNTIME CONFIG           â”‚
â”‚  (ConfiguraciÃ³n en memoria)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ğŸ—„ï¸ DATABASE CONFIG          â”‚
â”‚  (OrganizaciÃ³n, Facturas)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ğŸ“„ JSON CONFIG              â”‚
â”‚  (config.json - AplicaciÃ³n)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ğŸ”§ DEFAULT CONFIG           â”‚
â”‚  (Valores por defecto)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
                        
                        <h4>ğŸ”„ JerarquÃ­a de Precedencia</h4>
                        <ol>
                            <li><strong>Runtime Config</strong> - ConfiguraciÃ³n temporal en memoria</li>
                            <li><strong>Database Config</strong> - ConfiguraciÃ³n persistente del usuario</li>
                            <li><strong>JSON Config</strong> - ConfiguraciÃ³n de aplicaciÃ³n</li>
                            <li><strong>Default Config</strong> - Valores fallback seguros</li>
                        </ol>
                    </div>
                    <div class="col">
                        <h3>ğŸ¯ Tipos de ConfiguraciÃ³n</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Almacenamiento</th>
                                    <th>Uso</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>App Settings</strong></td>
                                    <td>config.json</td>
                                    <td>ConfiguraciÃ³n tÃ©cnica</td>
                                </tr>
                                <tr>
                                    <td><strong>User Preferences</strong></td>
                                    <td>Base de datos</td>
                                    <td>Preferencias usuario</td>
                                </tr>
                                <tr>
                                    <td><strong>Business Rules</strong></td>
                                    <td>Base de datos</td>
                                    <td>Reglas de negocio</td>
                                </tr>
                                <tr>
                                    <td><strong>Runtime State</strong></td>
                                    <td>Memoria</td>
                                    <td>Estado temporal</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸ“„ ConfiguraciÃ³n JSON: PatrÃ³n Singleton con Lazy Loading
            </div>
            <div class="card-body">
                <h3>ğŸ”§ ImplementaciÃ³n del Config Manager</h3>
                <p>La clase <code>Config</code> implementa un patrÃ³n Singleton con carga perezosa y auto-guardado:</p>
                
                <pre><code># utils/config.py - Sistema de ConfiguraciÃ³n Principal
class Config:
    """Clase para manejar la configuraciÃ³n de la aplicaciÃ³n"""
    
    def __init__(self):
        self.config_file = "config.json"
        self.default_config = {
            # ConfiguraciÃ³n de imÃ¡genes
            "default_image_directory": str(Path.home() / "Pictures"),
            "assets_directory": "assets/images",
            "max_image_size": 1024 * 1024,  # 1MB
            "supported_image_formats": [".png", ".jpg", ".jpeg", ".gif", ".bmp"],
            "image_display_size": (150, 150),
            
            # ConfiguraciÃ³n de numeraciÃ³n de facturas
            "factura_numero_inicial": 1,
            "factura_auto_increment": True,
            "factura_prefijo": "",
            "factura_sufijo": "",
            "factura_formato": "{prefijo}{numero}{sufijo}"
        }
        self.config = self.load_config()
    
    def load_config(self):
        """Carga la configuraciÃ³n desde el archivo con merge inteligente"""
        if os.path.exists(self.config_file):
            try:
                with open(self.config_file, 'r', encoding='utf-8') as f:
                    config = json.load(f)
                # Fusionar con la configuraciÃ³n por defecto para nuevas claves
                merged_config = self.default_config.copy()
                merged_config.update(config)
                return merged_config
            except (json.JSONDecodeError, IOError):
                return self.default_config.copy()
        else:
            return self.default_config.copy()
    
    def save_config(self):
        """Guarda la configuraciÃ³n con manejo de errores"""
        try:
            with open(self.config_file, 'w', encoding='utf-8') as f:
                json.dump(self.config, f, indent=2, ensure_ascii=False)
        except IOError:
            pass  # Ignora errores de guardado para no interrumpir la app
    
    def get(self, key, default=None):
        """Obtiene una valor de configuraciÃ³n con fallback"""
        return self.config.get(key, default)
    
    def set(self, key, value):
        """Establece un valor y guarda automÃ¡ticamente"""
        self.config[key] = value
        self.save_config()

# Instancia singleton global
app_config = Config()</code></pre>

                <div class="row">
                    <div class="col">
                        <h3>ğŸ¯ CaracterÃ­sticas Avanzadas</h3>
                        <ul>
                            <li><strong>Merge Inteligente:</strong> Combina configuraciÃ³n existente con nuevos defaults</li>
                            <li><strong>Auto-Save:</strong> Guardado automÃ¡tico en cada cambio</li>
                            <li><strong>Fallback Seguro:</strong> Valores por defecto si falla la carga</li>
                            <li><strong>Encoding UTF-8:</strong> Soporte completo para caracteres especiales</li>
                            <li><strong>Error Resilience:</strong> ContinÃºa funcionando aunque falle el guardado</li>
                        </ul>
                    </div>
                    <div class="col">
                        <h3>ğŸ”§ MÃ©todos Especializados</h3>
                        <pre><code># MÃ©todos especÃ­ficos por dominio
def get_default_image_directory(self):
    """Obtiene directorio con validaciÃ³n de existencia"""
    directory = self.get("default_image_directory")
    if os.path.exists(directory):
        return directory
    else:
        # Fallback al directorio home
        return str(Path.home())

def set_factura_numero_inicial(self, numero):
    """Establece nÃºmero inicial con validaciÃ³n"""
    if isinstance(numero, int) and numero > 0:
        self.set("factura_numero_inicial", numero)
        return True
    return False

def get_factura_formato(self):
    """Obtiene formato con template string"""
    return self.get("factura_formato", "{prefijo}{numero}{sufijo}")</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸ—„ï¸ ConfiguraciÃ³n en Base de Datos: Modelo Organizacion
            </div>
            <div class="card-body">
                <h3>ğŸ¢ ConfiguraciÃ³n de Negocio Persistente</h3>
                <p>La configuraciÃ³n especÃ­fica del negocio se almacena en la tabla <code>organizacion</code> usando un patrÃ³n Singleton de base de datos:</p>
                
                <pre><code># database/models.py - ConfiguraciÃ³n de OrganizaciÃ³n
class Organizacion:
    """Modelo de organizaciÃ³n con configuraciÃ³n de negocio"""
    
    def __init__(self, nombre="", direccion="", telefono="", email="", cif="",
                 logo_path="", directorio_imagenes_defecto="", numero_factura_inicial=1,
                 directorio_descargas_pdf="", visor_pdf_personalizado=""):
        self.nombre = nombre
        self.direccion = direccion
        self.telefono = telefono
        self.email = email
        self.cif = cif
        self.logo_path = logo_path
        self.directorio_imagenes_defecto = directorio_imagenes_defecto
        self.numero_factura_inicial = numero_factura_inicial
        self.directorio_descargas_pdf = directorio_descargas_pdf
        self.visor_pdf_personalizado = visor_pdf_personalizado
    
    def save(self):
        """Guarda configuraciÃ³n con patrÃ³n UPSERT"""
        # Verificar si ya existe una organizaciÃ³n
        existing = Organizacion.get()
        if existing and existing.nombre:  # Si existe y no estÃ¡ vacÃ­a
            query = '''UPDATE organizacion SET nombre=?, direccion=?, telefono=?,
                      email=?, cif=?, logo_path=?, directorio_imagenes_defecto=?,
                      numero_factura_inicial=?, directorio_descargas_pdf=?, 
                      visor_pdf_personalizado=?, fecha_actualizacion=CURRENT_TIMESTAMP
                      WHERE id=1'''
        else:
            query = '''INSERT INTO organizacion (id, nombre, direccion, telefono,
                      email, cif, logo_path, directorio_imagenes_defecto, 
                      numero_factura_inicial, directorio_descargas_pdf, 
                      visor_pdf_personalizado)
                      VALUES (1, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'''
        
        params = (self.nombre, self.direccion, self.telefono, self.email, 
                 self.cif, self.logo_path, self.directorio_imagenes_defecto,
                 self.numero_factura_inicial, self.directorio_descargas_pdf, 
                 self.visor_pdf_personalizado)
        
        db.execute_query(query, params)
    
    @staticmethod
    def get():
        """Obtiene la configuraciÃ³n de organizaciÃ³n (Singleton)"""
        query = "SELECT * FROM organizacion WHERE id=1"
        results = db.execute_query(query)
        if results:
            row = results[0]
            return Organizacion(
                nombre=row['nombre'], direccion=row['direccion'],
                telefono=row['telefono'], email=row['email'],
                cif=row['cif'], logo_path=row['logo_path'],
                directorio_imagenes_defecto=row['directorio_imagenes_defecto'],
                numero_factura_inicial=row['numero_factura_inicial'],
                directorio_descargas_pdf=row['directorio_descargas_pdf'],
                visor_pdf_personalizado=row['visor_pdf_personalizado']
            )
        return Organizacion()  # Retorna instancia vacÃ­a si no existe</code></pre>

                <div class="alert alert-success">
                    <h4>ğŸ¯ PatrÃ³n Singleton de Base de Datos</h4>
                    <p>La tabla <code>organizacion</code> implementa un Singleton a nivel de base de datos:</p>
                    <ul>
                        <li><strong>ID Fijo:</strong> Siempre usa <code>id=1</code> para garantizar una sola instancia</li>
                        <li><strong>UPSERT Pattern:</strong> INSERT si no existe, UPDATE si existe</li>
                        <li><strong>ConfiguraciÃ³n Centralizada:</strong> Toda la configuraciÃ³n de negocio en un lugar</li>
                        <li><strong>Timestamp AutomÃ¡tico:</strong> Tracking de cambios con <code>fecha_actualizacion</code></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸ”§ ConfiguraciÃ³n Especializada: NumeraciÃ³n de Facturas
            </div>
            <div class="card-body">
                <h3>ğŸ§® Sistema de NumeraciÃ³n Avanzado</h3>
                <p>El sistema implementa un servicio especializado para la numeraciÃ³n de facturas con templates configurables:</p>
                
                <pre><code># utils/factura_numbering.py - Servicio de NumeraciÃ³n
class FacturaNumberingService:
    """Servicio para generar y gestionar nÃºmeros de factura"""
    
    def __init__(self):
        self.db = Database()
        self.config = app_config
    
    def get_next_numero(self):
        """Obtiene el siguiente nÃºmero de factura"""
        # Obtener configuraciÃ³n actual
        org = Organizacion.get()
        numero_inicial = org.numero_factura_inicial or 1
        
        # Buscar el Ãºltimo nÃºmero usado
        query = """SELECT MAX(CAST(numero_factura AS INTEGER)) as max_numero 
                   FROM facturas WHERE numero_factura REGEXP '^[0-9]+$'"""
        result = self.db.execute_query(query)
        
        if result and result[0]['max_numero']:
            return result[0]['max_numero'] + 1
        else:
            return numero_inicial
    
    def format_numero_factura(self, numero):
        """Formatea el nÃºmero segÃºn la configuraciÃ³n"""
        org = Organizacion.get()
        prefijo = org.factura_prefijo or self.config.get_factura_prefijo()
        sufijo = org.factura_sufijo or self.config.get_factura_sufijo()
        formato = self.config.get_factura_formato()
        
        return formato.format(
            prefijo=prefijo,
            numero=numero,
            sufijo=sufijo
        )
    
    def generate_numero_factura(self):
        """Genera un nÃºmero de factura completo"""
        numero = self.get_next_numero()
        return self.format_numero_factura(numero)</code></pre>

                <div class="row">
                    <div class="col">
                        <h3>ğŸ“‹ ConfiguraciÃ³n de Templates</h3>
                        <pre><code># Ejemplo de configuraciÃ³n en config.json
{
  "factura_numero_inicial": 500,
  "factura_auto_increment": true,
  "factura_prefijo": "FACT",
  "factura_sufijo": "-2024",
  "factura_formato": "{prefijo}{numero}{sufijo}"
}

# Resultado: FACT500-2024, FACT501-2024, etc.</code></pre>
                    </div>
                    <div class="col">
                        <h3>ğŸ¯ CaracterÃ­sticas del Sistema</h3>
                        <ul>
                            <li><strong>Templates Flexibles:</strong> Formato configurable con placeholders</li>
                            <li><strong>Auto-incremento:</strong> NumeraciÃ³n automÃ¡tica secuencial</li>
                            <li><strong>Prefijos/Sufijos:</strong> PersonalizaciÃ³n completa</li>
                            <li><strong>ValidaciÃ³n:</strong> VerificaciÃ³n de nÃºmeros Ãºnicos</li>
                            <li><strong>Fallback:</strong> Valores por defecto seguros</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸ›ï¸ ConfiguraciÃ³n en Runtime: PatrÃ³n Observer
            </div>
            <div class="card-body">
                <h3>ğŸ”„ ConfiguraciÃ³n DinÃ¡mica y Reactiva</h3>
                <p>Para configuraciones que necesitan cambios en tiempo real, se implementa un patrÃ³n Observer simplificado:</p>
                
                <pre><code># utils/config_manager.py - ConfiguraciÃ³n Reactiva
class ConfigManager:
    """Gestor de configuraciÃ³n con notificaciones de cambios"""
    
    def __init__(self):
        self._observers = {}
        self._runtime_config = {}
    
    def subscribe(self, key, callback):
        """Suscribe un callback a cambios de configuraciÃ³n"""
        if key not in self._observers:
            self._observers[key] = []
        self._observers[key].append(callback)
    
    def set_runtime_config(self, key, value):
        """Establece configuraciÃ³n runtime y notifica cambios"""
        old_value = self._runtime_config.get(key)
        self._runtime_config[key] = value
        
        # Notificar a los observers si el valor cambiÃ³
        if old_value != value and key in self._observers:
            for callback in self._observers[key]:
                try:
                    callback(key, value, old_value)
                except Exception as e:
                    logger.error(f"Error en observer para {key}: {e}")
    
    def get_effective_config(self, key, default=None):
        """Obtiene configuraciÃ³n con precedencia runtime > db > json > default"""
        # 1. Runtime config (mayor precedencia)
        if key in self._runtime_config:
            return self._runtime_config[key]
        
        # 2. Database config
        if hasattr(self, '_db_config_cache'):
            if key in self._db_config_cache:
                return self._db_config_cache[key]
        
        # 3. JSON config
        json_value = app_config.get(key)
        if json_value is not None:
            return json_value
        
        # 4. Default fallback
        return default

# Ejemplo de uso
config_manager = ConfigManager()

# Suscribirse a cambios de tema
def on_theme_change(key, new_value, old_value):
    print(f"Tema cambiado de {old_value} a {new_value}")
    # Actualizar UI, recargar estilos, etc.

config_manager.subscribe("ui_theme", on_theme_change)</code></pre>

                <div class="alert alert-info">
                    <h4>ğŸ¯ Casos de Uso de ConfiguraciÃ³n Runtime</h4>
                    <ul>
                        <li><strong>Cambios de Tema:</strong> ActualizaciÃ³n inmediata de la UI</li>
                        <li><strong>ConfiguraciÃ³n de Debug:</strong> Activar/desactivar logging detallado</li>
                        <li><strong>ConfiguraciÃ³n de Performance:</strong> Ajustar cache, timeouts, etc.</li>
                        <li><strong>ConfiguraciÃ³n de Usuario:</strong> Preferencias temporales de sesiÃ³n</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                ğŸ“Š Ejemplo Real: ConfiguraciÃ³n Actual del Sistema
            </div>
            <div class="card-body">
                <h3>ğŸ”§ Archivo config.json en ProducciÃ³n</h3>
                <p>Este es el archivo de configuraciÃ³n real utilizado en el sistema:</p>

                <pre><code>{
  "default_image_directory": "/home/pascal/Documents",
  "assets_directory": "assets/images",
  "max_image_size": 1048576,
  "supported_image_formats": [
    ".png", ".jpg", ".jpeg", ".gif", ".bmp"
  ],
  "image_display_size": [150, 150],
  "factura_numero_inicial": 500,
  "factura_auto_increment": true,
  "factura_prefijo": "FACT",
  "factura_sufijo": "-2024",
  "factura_formato": "{prefijo}{numero}{sufijo}"
}</code></pre>

                <div class="row">
                    <div class="col">
                        <h3>ğŸ¯ AnÃ¡lisis de la ConfiguraciÃ³n</h3>
                        <ul>
                            <li><strong>Directorio Personalizado:</strong> Usuario configurÃ³ su directorio de documentos</li>
                            <li><strong>LÃ­mite de TamaÃ±o:</strong> 1MB mÃ¡ximo para imÃ¡genes (performance)</li>
                            <li><strong>Formatos MÃºltiples:</strong> Soporte amplio de formatos de imagen</li>
                            <li><strong>NumeraciÃ³n Personalizada:</strong> Facturas empiezan en 500 con formato FACT500-2024</li>
                        </ul>
                    </div>
                    <div class="col">
                        <h3>ğŸ”„ EvoluciÃ³n de la ConfiguraciÃ³n</h3>
                        <ul>
                            <li><strong>Merge AutomÃ¡tico:</strong> Nuevas configuraciones se aÃ±aden sin perder las existentes</li>
                            <li><strong>Backward Compatibility:</strong> Configuraciones antiguas siguen funcionando</li>
                            <li><strong>ValidaciÃ³n:</strong> Valores se validan antes de aplicar</li>
                            <li><strong>Fallback:</strong> Valores por defecto si la configuraciÃ³n es invÃ¡lida</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation-buttons">
            <a href="01-arquitectura-codigo.html" class="btn btn-secondary">â¬…ï¸ Arquitectura del CÃ³digo</a>
            <a href="03-base-datos-avanzada.html" class="btn btn-primary">Siguiente: Base de Datos Avanzada â¡ï¸</a>
        </div>

        <div class="footer">
            <p>&copy; 2024 FacturaciÃ³n FÃ¡cil - Tutorial de CodificaciÃ³n Avanzada</p>
        </div>
    </div>

    <script src="enhance_code_blocks.js"></script>
</body>
</html>
